# Upcoming title (comming soon)

## Synopsis


## Data Processing

### Loading libraries 

```{r message=FALSE}

library(stringr)
library(dplyr)
library(ggplot2)
library(xtable)

```


### Loading data into R

```{r cache=TRUE}

storms_df <- read.csv('repdata_data_StormData.csv.bz2', na.strings = c('NA', ''),
                      stringsAsFactors = FALSE)

```

### Examining raw data

```{r}

dim(storms_df)

sum(complete.cases(storms_df))

names(storms_df)

```


We take a close look at the `EVTYPE` variable which is extremely important for answering both questions addressed in this report. 

```{r}

unique_raw_events <- length(unique(storms_df$EVTYPE))
unique_raw_events

```


Although the official storm data documentation on the course assessment page lists 48 storm events (page 6), our dataset includes `r unique_raw_events` different event types. 

An examination of the data reveals that the reason for that huge difference in event types is caused by using different wording for the same kind of events in the raw data. 

For instance, you can find more than 80 variations for the official event type term _Thunderstorm Wind_:

```{r results='asis'}

tstm_subset_df <- group_by(storms_df, EVTYPE) %>%
  summarize(
    number_of_obs = n()
    ) %>% 
  arrange(EVTYPE)

print(xtable(tstm_subset_df[743:823, ], 
             caption = "<b>Table 1:</b> Examples of event type name modifications"), type = 'html', include.rownames = FALSE)


```
<br>

This is caused by:

1. Modifications of the official event type name (e.g., THUNDERSTORM  WINDS or THUNDERSTORM) 

2. Typos (e.g., THUDERSTORM WINDS or THUNDERSTORM WINS)

However, 82563 observations tagged with the official term _Thunderstorm Wind_  are included in the dataset whereas most of the event name modifications just include a single observation.

This shows that in the majority of the cases the event reporters used the official event type name.

### Event type number reduction strategy

In order to reduce the number of event types to a fair amount, we use a simple quantitative approach consisting of 5 steps:

1. We convert the `EVTYPE` column to lower case and remove leading and trailing white spaces 

2. For each of the remaining unique event types we calculate how much it contributes to the overall completeness of the number of observations

3. We decide on a threshold and select those event types which contribute the most to the overall amount of observations

4. We filter the loaded raw data according to chosen event types

5. The remaining set is further reduced by merging similar storm events with different wording  

#### Step 1: Removing leading and trailing which spaces

```{r}

storms_df$EVTYPE <- tolower(storms_df$EVTYPE)

storms_df$EVTYPE <- str_trim(storms_df$EVTYPE)

paste0("Total number of unique event types after first pre-processing step: ",
       length(unique(storms_df$EVTYPE)))

```


#### Step 2: Calculating the percentage / cumulative percentage that each event type contributes to the total amount of observations

* We will group the dataset by event type and calculate the total number of observations which belong to each event type. 

* After that we will calculate the __percentage__ each event type contributes to the overall amount of the observations.

* In addition, we will calculate the __cumulative percentage__ for each event type and sort the rows by the number of observations in descending order. 

```{r}

storms_by_evtype_df <- group_by(storms_df, EVTYPE) %>%
  summarize(
    numb_of_occ = n()
    ) %>%
  mutate(
    contrib_in_percent = round(numb_of_occ / nrow(storms_df), digits = 7),
    cumb_contrib_in_percent = round(
      order_by(desc(numb_of_occ), cumsum(contrib_in_percent)), digits = 7
      )
    ) %>%
  arrange(desc(numb_of_occ))

storms_by_evtype_df$rank <-  1:nrow(storms_by_evtype_df)

```

```{r results='asis'}

print(xtable(storms_by_evtype_df[1:47, ], 
             caption = "<b>Table 2:</b> The 47 event types with the highest observation percentage contribution", digits = 7), type = 'html', include.rownames = FALSE)

```
<br>


As the table above shows, the first 47 event types already make up for 99 % of the total amount of observations. 

This can be shown even better when plotting the grouped data.

```{r}
# Add dummy row at position (0,0) for plotting purposes
storms_by_evtype_df <- rbind(storms_by_evtype_df, c(0, 0, 0, 0, 0)) %>%
  arrange(cumb_contrib_in_percent)

```


<figure>
```{r cumulativeContributionFunction}

ggplot(storms_by_evtype_df, aes(rank, cumb_contrib_in_percent)) + 
  geom_line(color = 'steelblue') + 
  geom_vline(xintercept = 69) +
  xlab('Unique event types (ordered by descending percentage contribution)') +
  ylab('Observation completeness (in %)') +
  ggtitle('Cumulative observation completeness') + 
  theme_bw() +
  scale_x_continuous(breaks=seq(0, nrow(storms_by_evtype_df) , by = 100))

```
<figcaption>__Figure 1: Percentage contribution of each event type to total amount of observations.__ The x-axis represents all remaining `r nrow(storms_by_evtype_df)` event types (after the first pre-processing step) in the dataset expressed in numbers and ordered by their descending percentage contribution. The first 69 event types (vertical line) account for 99,5 % of the total amount of obervations. Especially, the last `r length(storms_by_evtype_df$numb_of_occ[storms_by_evtype_df$numb_of_occ < 6])` event types only contribute a tiny fraction to the overall percentage completeness of the observations, due to the fact that less than 6 observations belong to each of those event types. The last `r length(storms_by_evtype_df$numb_of_occ[storms_by_evtype_df$numb_of_occ == 1])` event types even only contribute a single observation. </figcaption></figure>

```{r}
# Remove dummy row
storms_by_evtype_df <- storms_by_evtype_df[-1, ]

```


#### Step 3: Choosing the event types which contribute the most to the amount of observations

We decide to include the  first 69 ordered event types which account for 99,5 % of the total amount of observations as you can see in the `cumb_contrib_in_percent` column below.

```{r results='asis'}

print(xtable(filter(storms_by_evtype_df, rank == 69), digits = 7), type = 'html', 
      include.rownames = FALSE)

```
<br>

This is equivalent to include all event types which contribute more than 100 observations to the dataset.

```{r}

storms_by_evtype_df <- filter(storms_by_evtype_df, numb_of_occ > 100)

selected_evtypes <- storms_by_evtype_df$EVTYPE

```


#### Step 4: Filter the loaded raw data according to chosen event types 


From the raw data we just select those observations which belong to one of the derived event types. 

```{r}

original_row_numbers <- nrow(storms_df)

storms_df <- filter(storms_df, EVTYPE %in% selected_evtypes)

new_row_numbers <- nrow(storms_df)

paste0('The reduced dataset includes ', round(new_row_numbers/original_row_numbers, 
                                              digits = 3) * 100, 
       ' % of the original observation amount, exactly as decided by our threshold choice in Step 3.')

```

#### Step 5: Merge similar event types

After that we merge similar event types with different wording to reduce the amount of unique event type names even further.

```{r}

storms_df$EVTYPE <- gsub('extreme windchill|extreme cold$', 
                                   'extreme cold/wind chill',
                                   storms_df$EVTYPE)
storms_df$EVTYPE[storms_df$EVTYPE == 'marine tstm wind'] <- 'marine thunderstorm wind'
storms_df$EVTYPE <- gsub('thunderstorm winds|^tstm wind$|tstm wind/hail', 
                                   'thunderstorm wind',
                                   storms_df$EVTYPE)
storms_df$EVTYPE <- gsub('flood/flash flood|flash flooding',
                                   'flash flood',
                                   storms_df$EVTYPE)
storms_df$EVTYPE[storms_df$EVTYPE == 'storm surge'] <-  'storm surge/tide'
storms_df$EVTYPE[storms_df$EVTYPE == 'hurricane'] <-  'hurricane (typhoon)'
storms_df$EVTYPE[storms_df$EVTYPE == 'flooding'] <-  'flood'
storms_df$EVTYPE[storms_df$EVTYPE == 'heavy surf/high surf'] <- 'high surf'                                  
storms_df$EVTYPE[storms_df$EVTYPE == 'high winds'] <-  'high wind'
storms_df$EVTYPE[storms_df$EVTYPE == 'winter weather/mix'] <- 'winter weather'
storms_df$EVTYPE[storms_df$EVTYPE == 'rip currents'] <- 'rip current'
storms_df$EVTYPE[storms_df$EVTYPE == 'strong winds'] <- 'strong wind'
storms_df$EVTYPE[storms_df$EVTYPE == 'coastal flooding']  <- 'coastal flood'
storms_df$EVTYPE[storms_df$EVTYPE == 'wild/forest fire']  <- 'wildfire'
storms_df$EVTYPE[storms_df$EVTYPE == 'moderate snowfall']  <- 'moderate snow'
storms_df$EVTYPE[storms_df$EVTYPE == 'urban/sml stream fld']  <- 'urban flood'
storms_df$EVTYPE[storms_df$EVTYPE == 'unseasonably warm']  <- 'excessive heat'
storms_df$EVTYPE[storms_df$EVTYPE == 'record warmth']  <- 'excessive heat'

paste0("Total number of unique event types after last pre-processing step: ",
       length(unique(storms_df$EVTYPE)))

```

By applying our event type reduction strategy, we were able to reduce the number of event types from `r unique_raw_events` to `r length(unique(storms_df$EVTYPE))`. In the process we omitted 0.05 % of the observations from the original raw data. However, slight differences remain when you compare the unique event type names in our processed dataset with the official ones described in the storms data documentation on page 6:
      
Additional event types    Missing event types
------------------------  ---------------------
astronomical high tide    debris flow
dry microburst            dense smoke
fog                       freezing fog
freezing rain             lakeshore flood
landslide                 marine strong wind
light snow                seiche
moderate snow             sleet
snow                      tropcial depression
river flood               tsunami
urban flood               volcanic ash
wind

Table:  <b>Table 3:</b> Differences in event type names between original documentation and processed data




## Results

Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

Across the United States, which types of events have the greatest economic consequences?
